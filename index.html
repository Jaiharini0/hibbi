<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Hibiscus AR Labels</title>
    <meta name="description" content="WebAR Hibiscus Model with Auto Labels" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.2/aframe/build/aframe-ar.min.js"></script>
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
  </head>

  <body style="margin: 0; overflow: hidden">
    <a-scene
      embedded
      arjs="sourceType: webcam; debugUIEnabled: false;"
      renderer="antialias: true; alpha: true"
      cursor="rayOrigin: mouse"
      raycaster="objects: .clickable"
    >
      <!-- Light -->
      <a-entity light="type: directional; color: #fff; intensity: 1" position="2 4 3"></a-entity>
      <a-entity light="type: ambient; color: #bbb"></a-entity>

      <!-- Camera -->
      <a-camera position="0 1.6 3" look-controls></a-camera>

      <!-- Hibiscus Model -->
      <a-entity
        id="hibiscus"
        gltf-model="#flowerModel"
        visible="true"
        scale="0.5 0.5 0.5"
        position="0 0 0"
        rotation="0 180 0"
        label-on-click
      ></a-entity>

      <!-- Asset preload -->
      <a-assets>
        <a-asset-item id="flowerModel" src="hibiscus.glb"></a-asset-item>
      </a-assets>

      <!-- Label-on-click component -->
      <script>
        AFRAME.registerComponent("label-on-click", {
          init: function () {
            const el = this.el;
            const scene = document.querySelector("a-scene");

            el.addEventListener("model-loaded", () => {
              const mesh = el.getObject3D("mesh");

              mesh.traverse((node) => {
                if (node.isMesh) {
                  node.name = node.name || "Unnamed";
                  const wrapper = document.createElement("a-entity");
                  wrapper.setAttribute("class", "clickable");

                  // Position wrapper at the part
                  wrapper.object3D.position.copy(node.getWorldPosition(new THREE.Vector3()));

                  // Make it visible to raycaster
                  wrapper.setAttribute("geometry", {
                    primitive: "sphere",
                    radius: 0.05,
                  });
                  wrapper.setAttribute("material", "opacity: 0; transparent: true");

                  wrapper.addEventListener("click", () => {
                    // Remove previous labels
                    const oldLabels = document.querySelectorAll(".label");
                    oldLabels.forEach((l) => l.parentNode.removeChild(l));

                    // Add label
                    const label = document.createElement("a-entity");
                    label.setAttribute("class", "label");
                    label.setAttribute("position", "0 0.15 0"); // Above the part
                    label.setAttribute("text", {
                      value: node.name,
                      align: "center",
                      color: "#ffcc00",
                      width: 3,
                      baseline: "bottom",
                    });

                    wrapper.appendChild(label);
                  });

                  scene.appendChild(wrapper);
                }
              });
            });
          },
        });
      </script>
    </a-scene>
  </body>
</html>
